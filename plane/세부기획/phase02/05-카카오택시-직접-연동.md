# Phase 2 - ì¹´ì¹´ì˜¤íƒì‹œ ì§ì ‘ ì—°ë™
## ê¸°ëŠ¥ ìƒì„¸ ê¸°íšì„œ

> **ê°œë°œ ìš°ì„ ìˆœìœ„**: â­â­â­ (ìµœìš°ì„ )
> **ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 3ì£¼
> **ë‹´ë‹¹**: Frontend 1ëª… + Backend 2ëª…
> **ê¸°ìˆ **: Kakao Mobility API

---

## ê¸°ëŠ¥ ê°œìš”

### Phase 1 vs Phase 2
- **Phase 1**: ì¹´ì¹´ì˜¤íƒì‹œ ì•± ë”¥ë§í¬ ë°©ì‹
- **Phase 2**: **ì¹´ì¹´ì˜¤ Mobility API ì§ì ‘ ì—°ë™** (ì•± ë‚´ í˜¸ì¶œ)

### í•µì‹¬ ê°€ì¹˜
- ì¹´ì¹´ì˜¤íƒì‹œ ì•± ì„¤ì¹˜ **ë¶ˆí•„ìš”**
- ì•± ë‚´ì—ì„œ íƒì‹œ í˜¸ì¶œ ë° ê²°ì œ ì™„ê²°
- ì‹¤ì‹œê°„ ë°°ì°¨ ì •ë³´ í™•ì¸
- ìë™ ê²°ì œ (ê°€ì¡± ì¹´ë“œ ë“±ë¡ ê°€ëŠ¥)

---

## Kakao Mobility API

### API êµ¬ì„±
```typescript
interface KakaoMobilityAPI {
  // 1. íƒì‹œ í˜¸ì¶œ
  call: {
    endpoint: '/v1/taxi/call',
    method: 'POST',
    auth: 'KakaoAK {ADMIN_KEY}'
  };

  // 2. ë°°ì°¨ ìƒíƒœ ì¡°íšŒ
  status: {
    endpoint: '/v1/taxi/call/{call_id}',
    method: 'GET'
  };

  // 3. íƒì‹œ ìœ„ì¹˜ ì¶”ì 
  location: {
    endpoint: '/v1/taxi/location/{call_id}',
    method: 'GET',
    realtime: true
  };

  // 4. í˜¸ì¶œ ì·¨ì†Œ
  cancel: {
    endpoint: '/v1/taxi/call/{call_id}/cancel',
    method: 'POST'
  };

  // 5. ìš”ê¸ˆ ì •ì‚°
  payment: {
    endpoint: '/v1/taxi/payment',
    method: 'POST'
  };
}
```

---

## íƒì‹œ í˜¸ì¶œ í”Œë¡œìš° (Phase 2)

### 1. ëª©ì ì§€ ì„ íƒ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  íƒì‹œ ë¶€ë¥´ê¸°                         â”‚
â”‚                                      â”‚
â”‚  ì–´ë””ë¡œ ê°€ì‹œë‚˜ìš”?                    â”‚
â”‚                                      â”‚
â”‚  â”â”â” ìì£¼ ê°€ëŠ” ê³³ â”â”â”              â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ¥ ì„œìš¸ëŒ€ë³‘ì›      â”‚             â”‚
â”‚  â”‚ 2.3km Â· ì•½ 15ë¶„    â”‚             â”‚
â”‚  â”‚ ì˜ˆìƒ ìš”ê¸ˆ: 15,000ì›â”‚             â”‚
â”‚  â”‚ [ì„ íƒ]             â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ğŸ¬ ì´ë§ˆíŠ¸ ì²œí˜¸ì    â”‚             â”‚
â”‚  â”‚ 1.8km Â· ì•½ 10ë¶„    â”‚             â”‚
â”‚  â”‚ ì˜ˆìƒ ìš”ê¸ˆ: 12,000ì›â”‚             â”‚
â”‚  â”‚ [ì„ íƒ]             â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                      â”‚
â”‚  [+ ìƒˆ ëª©ì ì§€ ì…ë ¥]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. íƒì‹œ í˜¸ì¶œ í™•ì¸
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  íƒì‹œ í˜¸ì¶œ í™•ì¸                      â”‚
â”‚                                      â”‚
â”‚  ì¶œë°œì§€:                             â”‚
â”‚  ğŸ“ í˜„ì¬ ìœ„ì¹˜                       â”‚
â”‚  ì„œìš¸ì‹œ ê°•ë™êµ¬ ì²œí˜¸ë™ 123-45        â”‚
â”‚                                      â”‚
â”‚  ë„ì°©ì§€:                             â”‚
â”‚  ğŸ¥ ì„œìš¸ëŒ€ë³‘ì›                      â”‚
â”‚  ì„œìš¸ì‹œ ì¢…ë¡œêµ¬ ëŒ€í•™ë¡œ 101           â”‚
â”‚                                      â”‚
â”‚  [ì§€ë„ë¡œ ê²½ë¡œ ë³´ê¸°]                 â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  ê±°ë¦¬: ì•½ 12.5km                    â”‚
â”‚  ì˜ˆìƒ ì‹œê°„: ì•½ 25ë¶„                 â”‚
â”‚  ì˜ˆìƒ ìš”ê¸ˆ: 15,000ì›                â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  íƒì‹œ ì¢…ë¥˜ ì„ íƒ:                     â”‚
â”‚  â—‰ ì¼ë°˜ íƒì‹œ (15,000ì›)            â”‚
â”‚  â—‹ ëª¨ë²” íƒì‹œ (22,000ì›)            â”‚
â”‚  â—‹ ëŒ€í˜• íƒì‹œ (18,000ì›)            â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  ğŸ’³ ê²°ì œ ìˆ˜ë‹¨                       â”‚
â”‚  â—‰ ì•± ë‚´ ìë™ ê²°ì œ                 â”‚
â”‚     [KBêµ­ë¯¼ì¹´ë“œ ****1234 â–¼]        â”‚
â”‚  â—‹ í˜„ì¥ ê²°ì œ (í˜„ê¸ˆ/ì¹´ë“œ)           â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  â˜‘ ê°€ì¡±ì—ê²Œ ì‹¤ì‹œê°„ ìœ„ì¹˜ ê³µìœ         â”‚
â”‚  í°ë”¸ (ê¹€ë¯¸ì˜) â˜‘                    â”‚
â”‚  ì‘ì€ë”¸ (ê¹€ìˆ˜ì˜) â˜                  â”‚
â”‚                                      â”‚
â”‚  [íƒì‹œ í˜¸ì¶œí•˜ê¸°]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ë°°ì°¨ ì¤‘
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸš• íƒì‹œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...         â”‚
â”‚                                      â”‚
â”‚  [ë¡œë”© ì• ë‹ˆë©”ì´ì…˜]                  â”‚
â”‚                                      â”‚
â”‚  ê·¼ì²˜ íƒì‹œë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤          â”‚
â”‚  ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”                 â”‚
â”‚                                      â”‚
â”‚  í‰ê·  ë°°ì°¨ ì‹œê°„: ì•½ 3ë¶„             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†“ ë°°ì°¨ ì™„ë£Œ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… íƒì‹œ ë°°ì°¨ ì™„ë£Œ!                 â”‚
â”‚                                      â”‚
â”‚  [íƒì‹œ ì‚¬ì§„]                        â”‚
â”‚                                      â”‚
â”‚  ì°¨ëŸ‰ ë²ˆí˜¸: 12ê°€ 3456               â”‚
â”‚  ê¸°ì‚¬ë‹˜: ê¹€â—‹â—‹                      â”‚
â”‚  â­ 4.8 (892íšŒ)                     â”‚
â”‚                                      â”‚
â”‚  [ì§€ë„ í‘œì‹œ]                        â”‚
â”‚  ğŸ“ íƒì‹œ ì‹¤ì‹œê°„ ìœ„ì¹˜                â”‚
â”‚                                      â”‚
â”‚  í˜„ì¬ ìœ„ì¹˜: 500m ë–¨ì–´ì§„ ê³³          â”‚
â”‚  ì˜ˆìƒ ë„ì°©: ì•½ 2ë¶„ í›„               â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  ğŸ’¡ ì¤€ë¹„í•˜ì„¸ìš”!                     â”‚
â”‚  ê³§ íƒì‹œê°€ ë„ì°©í•©ë‹ˆë‹¤               â”‚
â”‚                                      â”‚
â”‚  [ê¸°ì‚¬ë‹˜ê»˜ ì „í™”í•˜ê¸°]                â”‚
â”‚  [í˜¸ì¶œ ì·¨ì†Œ]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. íƒì‹œ ì´ë™ ì¤‘
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸš• ëª©ì ì§€ë¡œ ì´ë™ ì¤‘                â”‚
â”‚                                      â”‚
â”‚  ì„œìš¸ëŒ€ë³‘ì›ê¹Œì§€                     â”‚
â”‚                                      â”‚
â”‚  [ì§€ë„ - ì‹¤ì‹œê°„ ê²½ë¡œ í‘œì‹œ]          â”‚
â”‚                                      â”‚
â”‚  í˜„ì¬ ìœ„ì¹˜: ì¢…ë¡œ3ê°€ ì‚¬ê±°ë¦¬          â”‚
â”‚  ë‚¨ì€ ê±°ë¦¬: ì•½ 8.2km                â”‚
â”‚  ì˜ˆìƒ ë„ì°©: 15ë¶„ í›„ (14:35)         â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  í˜„ì¬ ìš”ê¸ˆ: 12,500ì›                â”‚
â”‚  (ìµœì¢… ìš”ê¸ˆì€ ë„ì°© í›„ ê²°ì •)         â”‚
â”‚                                      â”‚
â”‚  [ê¸°ì‚¬ë‹˜ê»˜ ì „í™”í•˜ê¸°]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. ë„ì°© ë° ìë™ ê²°ì œ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ëª©ì ì§€ ë„ì°©                     â”‚
â”‚                                      â”‚
â”‚  ì„œìš¸ëŒ€ë³‘ì›                         â”‚
â”‚  2025-02-20 14:32                   â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  ì´ë™ ê±°ë¦¬: 12.8km                  â”‚
â”‚  ì´ë™ ì‹œê°„: 27ë¶„                    â”‚
â”‚                                      â”‚
â”‚  ìµœì¢… ìš”ê¸ˆ: 16,200ì›                â”‚
â”‚                                      â”‚
â”‚  ğŸ’³ ìë™ ê²°ì œ ì™„ë£Œ                  â”‚
â”‚  KBêµ­ë¯¼ì¹´ë“œ ****1234                â”‚
â”‚                                      â”‚
â”‚  [ì˜ìˆ˜ì¦ ë³´ê¸°]                      â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  ê¹€â—‹â—‹ ê¸°ì‚¬ë‹˜ ì–´ë– ì…¨ë‚˜ìš”?           â”‚
â”‚                                      â”‚
â”‚  â­â­â­â­â­                       â”‚
â”‚                                      â”‚
â”‚  [í‰ê°€í•˜ê¸°]                         â”‚
â”‚  [ì˜ìˆ˜ì¦ ì´ë©”ì¼ë¡œ ë°›ê¸°]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## DB ìŠ¤í‚¤ë§ˆ

```sql
-- íƒì‹œ í˜¸ì¶œ (Phase 1ì—ì„œ í™•ì¥)
ALTER TABLE taxi_calls ADD COLUMN kakao_call_id VARCHAR(100);
ALTER TABLE taxi_calls ADD COLUMN taxi_type VARCHAR(50); -- 'regular', 'deluxe', 'large'
ALTER TABLE taxi_calls ADD COLUMN payment_method VARCHAR(50);
ALTER TABLE taxi_calls ADD COLUMN auto_payment BOOLEAN DEFAULT false;

-- íƒì‹œ ì •ë³´
ALTER TABLE taxi_calls ADD COLUMN taxi_number VARCHAR(20);
ALTER TABLE taxi_calls ADD COLUMN driver_name VARCHAR(100);
ALTER TABLE taxi_calls ADD COLUMN driver_phone VARCHAR(20);
ALTER TABLE taxi_calls ADD COLUMN driver_rating DECIMAL(2, 1);

-- ì´ë™ ì •ë³´
ALTER TABLE taxi_calls ADD COLUMN distance_km DECIMAL(5, 2);
ALTER TABLE taxi_calls ADD COLUMN duration_minutes INTEGER;
ALTER TABLE taxi_calls ADD COLUMN final_fare INTEGER;

-- ê²°ì œ
ALTER TABLE taxi_calls ADD COLUMN payment_id VARCHAR(100);
ALTER TABLE taxi_calls ADD COLUMN paid_at TIMESTAMP WITH TIME ZONE;

-- í‰ê°€
ALTER TABLE taxi_calls ADD COLUMN driver_rating_by_user INTEGER;
ALTER TABLE taxi_calls ADD COLUMN review TEXT;
```

---

## API ì—”ë“œí¬ì¸íŠ¸

### íƒì‹œ í˜¸ì¶œ
```typescript
// POST /api/taxi/call-kakao
export async function POST(req: Request) {
  const {
    userId,
    startLocation,
    destinationId,
    destination,
    taxiType,
    paymentMethod,
    sharedWithFamily
  } = await req.json();

  // 1. ì¹´ì¹´ì˜¤ Mobility API í˜¸ì¶œ
  const kakaoResponse = await fetch(
    'https://apis-navi.kakaomobility.com/v1/taxi/call',
    {
      method: 'POST',
      headers: {
        'Authorization': `KakaoAK ${process.env.KAKAO_MOBILITY_ADMIN_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        origin: {
          x: startLocation.longitude,
          y: startLocation.latitude,
          name: startLocation.address
        },
        destination: {
          x: destination.longitude,
          y: destination.latitude,
          name: destination.address
        },
        taxi_type: taxiType,
        payment: {
          method: paymentMethod === 'auto' ? 'card' : 'onsite',
          card_id: paymentMethod === 'auto' ? await getUserCardId(userId) : null
        },
        user: {
          phone: await getUserPhone(userId),
          name: await getUserName(userId)
        }
      })
    }
  );

  const kakaoData = await kakaoResponse.json();

  if (!kakaoData.success) {
    return Response.json({
      success: false,
      error: {
        code: 'KAKAO_CALL_FAILED',
        message: 'íƒì‹œ í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'
      }
    }, { status: 400 });
  }

  // 2. ìì²´ DBì— ê¸°ë¡
  const { data: taxiCall } = await supabase
    .from('taxi_calls')
    .insert({
      user_id: userId,
      kakao_call_id: kakaoData.call_id,
      start_address: startLocation.address,
      start_latitude: startLocation.latitude,
      start_longitude: startLocation.longitude,
      destination_id: destinationId,
      destination_address: destination.address,
      destination_latitude: destination.latitude,
      destination_longitude: destination.longitude,
      taxi_type: taxiType,
      payment_method: paymentMethod,
      auto_payment: paymentMethod === 'auto',
      estimated_fare: kakaoData.estimated_fare,
      shared_with_family: sharedWithFamily,
      status: 'searching'
    })
    .select()
    .single();

  // 3. ë°°ì°¨ ìƒíƒœ í´ë§ ì‹œì‘
  startDispatchPolling(taxiCall.id, kakaoData.call_id);

  // 4. ê°€ì¡±ì—ê²Œ ì•Œë¦¼
  if (sharedWithFamily && sharedWithFamily.length > 0) {
    await sendFamilyNotifications(userId, {
      title: 'ğŸš• íƒì‹œ í˜¸ì¶œ',
      body: `${destination.address}(ìœ¼)ë¡œ ê°€ëŠ” íƒì‹œë¥¼ í˜¸ì¶œí–ˆìŠµë‹ˆë‹¤`,
      taxiCallId: taxiCall.id
    });
  }

  return Response.json({
    success: true,
    data: {
      callId: taxiCall.id,
      kakaoCallId: kakaoData.call_id,
      estimatedFare: kakaoData.estimated_fare,
      estimatedWaitTime: kakaoData.estimated_wait_time
    }
  });
}
```

### ë°°ì°¨ ìƒíƒœ í´ë§
```typescript
const startDispatchPolling = async (
  callId: string,
  kakaoCallId: string
) => {
  const pollInterval = setInterval(async () => {
    // ì¹´ì¹´ì˜¤ APIì—ì„œ ìƒíƒœ ì¡°íšŒ
    const status = await fetch(
      `https://apis-navi.kakaomobility.com/v1/taxi/call/${kakaoCallId}`,
      {
        headers: {
          'Authorization': `KakaoAK ${process.env.KAKAO_MOBILITY_ADMIN_KEY}`
        }
      }
    ).then(res => res.json());

    // DB ì—…ë°ì´íŠ¸
    const updates: any = { status: status.status };

    if (status.status === 'dispatched') {
      // ë°°ì°¨ ì™„ë£Œ
      updates.taxi_number = status.taxi.vehicle_number;
      updates.driver_name = status.taxi.driver_name;
      updates.driver_phone = status.taxi.driver_phone;
      updates.driver_rating = status.taxi.driver_rating;

      // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
      const taxiCall = await getTaxiCall(callId);
      await sendNotification({
        userId: taxiCall.user_id,
        title: 'âœ… íƒì‹œ ë°°ì°¨ ì™„ë£Œ!',
        body: `${status.taxi.vehicle_number} - ${status.estimated_arrival}ë¶„ í›„ ë„ì°©`,
        data: {
          type: 'taxi_dispatched',
          callId
        }
      });

      // í´ë§ ì¤‘ì§€
      clearInterval(pollInterval);
    } else if (status.status === 'cancelled' || status.status === 'failed') {
      // í˜¸ì¶œ ì‹¤íŒ¨
      clearInterval(pollInterval);
    }

    await supabase
      .from('taxi_calls')
      .update(updates)
      .eq('id', callId);

  }, 3000); // 3ì´ˆë§ˆë‹¤ ì¡°íšŒ
};
```

### ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì 
```typescript
// GET /api/taxi/:callId/location
export async function GET(
  req: Request,
  { params }: { params: { callId: string } }
) {
  const taxiCall = await getTaxiCall(params.callId);

  if (!taxiCall.kakao_call_id) {
    return Response.json({
      success: false,
      error: { code: 'NO_KAKAO_CALL_ID', message: 'í˜¸ì¶œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }
    }, { status: 404 });
  }

  // ì¹´ì¹´ì˜¤ APIì—ì„œ ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¡°íšŒ
  const location = await fetch(
    `https://apis-navi.kakaomobility.com/v1/taxi/location/${taxiCall.kakao_call_id}`,
    {
      headers: {
        'Authorization': `KakaoAK ${process.env.KAKAO_MOBILITY_ADMIN_KEY}`
      }
    }
  ).then(res => res.json());

  return Response.json({
    success: true,
    data: {
      latitude: location.latitude,
      longitude: location.longitude,
      current_address: location.address,
      distance_to_pickup: location.distance_to_pickup,
      estimated_arrival: location.estimated_arrival,
      status: location.status
    }
  });
}
```

### í˜¸ì¶œ ì·¨ì†Œ
```typescript
// POST /api/taxi/:callId/cancel
export async function POST(
  req: Request,
  { params }: { params: { callId: string } }
) {
  const taxiCall = await getTaxiCall(params.callId);

  // ì¹´ì¹´ì˜¤ APIë¡œ ì·¨ì†Œ ìš”ì²­
  const cancelResponse = await fetch(
    `https://apis-navi.kakaomobility.com/v1/taxi/call/${taxiCall.kakao_call_id}/cancel`,
    {
      method: 'POST',
      headers: {
        'Authorization': `KakaoAK ${process.env.KAKAO_MOBILITY_ADMIN_KEY}`
      }
    }
  ).then(res => res.json());

  if (cancelResponse.success) {
    // DB ì—…ë°ì´íŠ¸
    await supabase
      .from('taxi_calls')
      .update({
        status: 'cancelled',
        cancelled_at: new Date()
      })
      .eq('id', params.callId);

    // ì•Œë¦¼
    await sendNotification({
      userId: taxiCall.user_id,
      title: 'íƒì‹œ í˜¸ì¶œ ì·¨ì†Œ',
      body: 'íƒì‹œ í˜¸ì¶œì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤'
    });
  }

  return Response.json({ success: cancelResponse.success });
}
```

### ìë™ ê²°ì œ ì²˜ë¦¬
```typescript
// íƒ‘ìŠ¹ ì™„ë£Œ ì‹œ ìë™ í˜¸ì¶œ
export const processAutoPayment = async (
  callId: string,
  kakaoCallId: string
) => {
  // ì¹´ì¹´ì˜¤ APIì—ì„œ ìµœì¢… ìš”ê¸ˆ ì¡°íšŒ
  const fareData = await fetch(
    `https://apis-navi.kakaomobility.com/v1/taxi/fare/${kakaoCallId}`,
    {
      headers: {
        'Authorization': `KakaoAK ${process.env.KAKAO_MOBILITY_ADMIN_KEY}`
      }
    }
  ).then(res => res.json());

  const taxiCall = await getTaxiCall(callId);

  if (taxiCall.auto_payment) {
    // ìë™ ê²°ì œ ì‹¤í–‰
    const payment = await processPayment({
      amount: fareData.final_fare,
      method: taxiCall.payment_method,
      userId: taxiCall.user_id,
      description: `íƒì‹œ ìš”ê¸ˆ - ${taxiCall.destination_address}`
    });

    // DB ì—…ë°ì´íŠ¸
    await supabase
      .from('taxi_calls')
      .update({
        status: 'completed',
        distance_km: fareData.distance_km,
        duration_minutes: fareData.duration_minutes,
        final_fare: fareData.final_fare,
        payment_id: payment.id,
        paid_at: new Date(),
        actual_arrival_time: new Date()
      })
      .eq('id', callId);

    // ì•Œë¦¼
    await sendNotification({
      userId: taxiCall.user_id,
      title: 'âœ… ëª©ì ì§€ ë„ì°© & ê²°ì œ ì™„ë£Œ',
      body: `${fareData.final_fare.toLocaleString()}ì›ì´ ìë™ ê²°ì œë˜ì—ˆìŠµë‹ˆë‹¤`,
      data: {
        type: 'taxi_payment_completed',
        callId
      }
    });

    // ê°€ì¡±ì—ê²Œë„ ì•Œë¦¼
    if (taxiCall.shared_with_family) {
      await sendFamilyNotifications(taxiCall.user_id, {
        title: 'íƒì‹œ ë„ì°© ì™„ë£Œ',
        body: `ì–´ë¨¸ë‹ˆê°€ ${taxiCall.destination_address}ì— ë„ì°©í•˜ì…¨ìŠµë‹ˆë‹¤`,
        callId
      });
    }
  }
};
```

---

## ê°€ì¡± ëŒ€ë¦¬ í˜¸ì¶œ (Phase 2 ê°•í™”)

```typescript
// POST /api/taxi/call-for-family
export async function POST(req: Request) {
  const {
    familyId, // í˜¸ì¶œí•˜ëŠ” ê°€ì¡±
    seniorId, // ì‹œë‹ˆì–´
    startLocation, // ì‹œë‹ˆì–´ ìœ„ì¹˜
    destination,
    taxiType,
    paymentMethod // ê°€ì¡± ì¹´ë“œë¡œ ê²°ì œ
  } = await req.json();

  // ì¹´ì¹´ì˜¤ íƒì‹œ í˜¸ì¶œ (ì‹œë‹ˆì–´ ìœ„ì¹˜ì—ì„œ)
  const kakaoResponse = await callKakaoTaxi({
    origin: startLocation,
    destination,
    taxiType,
    payment: {
      method: 'card',
      card_id: await getFamilyCardId(familyId) // ê°€ì¡± ì¹´ë“œ
    },
    user: {
      phone: await getUserPhone(seniorId), // ì‹œë‹ˆì–´ ì—°ë½ì²˜
      name: await getUserName(seniorId)
    }
  });

  // DB ê¸°ë¡
  const { data: taxiCall } = await supabase
    .from('taxi_calls')
    .insert({
      user_id: seniorId,
      caller_id: familyId, // ëŒ€ë¦¬ í˜¸ì¶œí•œ ê°€ì¡±
      ...
    })
    .select()
    .single();

  // ì‹œë‹ˆì–´ì—ê²Œ ì•Œë¦¼
  await sendNotification({
    userId: seniorId,
    title: 'ğŸ“± ë”¸ì´ íƒì‹œë¥¼ ë¶ˆëŸ¬ë“œë ¸ì–´ìš”',
    body: `${destination.address}(ìœ¼)ë¡œ ê°€ëŠ” íƒì‹œê°€ ê³§ ë„ì°©í•©ë‹ˆë‹¤`,
    data: {
      type: 'taxi_proxy_call',
      callId: taxiCall.id
    }
  });

  return Response.json({ success: true, data: taxiCall });
}
```

---

**ì‘ì„±ì¼**: 2025-01-24
**ë²„ì „**: 1.0
**ë‹¤ìŒ ë¬¸ì„œ**: 06-AI-ê±´ê°•-ë¶„ì„-ê³ ë„í™”.md
