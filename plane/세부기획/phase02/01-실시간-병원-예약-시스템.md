# Phase 2 - ì‹¤ì‹œê°„ ë³‘ì› ì˜ˆì•½ ì‹œìŠ¤í…œ
## ê¸°ëŠ¥ ìƒì„¸ ê¸°íšì„œ

> **ê°œë°œ ìš°ì„ ìˆœìœ„**: â­â­â­ (ìµœìš°ì„ )
> **ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 6ì£¼
> **ë‹´ë‹¹**: Frontend 2ëª… + Backend 2ëª…
> **ê¸°ìˆ **: ë³‘ì› ì˜ˆì•½ ì‹œìŠ¤í…œ API, Payment Gateway (PGì‚¬ ì—°ë™)

---

## ê¸°ëŠ¥ ê°œìš”

### Phase 1 vs Phase 2
- **Phase 1**: ë³‘ì› ì •ë³´ ì œê³µ + ì „í™” ì—°ê²° + ìˆ˜ë™ ì¼ì • ê´€ë¦¬
- **Phase 2**: **ì‹¤ì‹œê°„ ì˜ˆì•½ + ìë™ ê²°ì œ + ì˜ˆì•½ í™•ì • ì•Œë¦¼**

### í•µì‹¬ ê°€ì¹˜
- ì „í™” ì—†ì´ ì•±ì—ì„œ **ì›í´ë¦­ ì˜ˆì•½**
- ë³‘ì› ì‹¤ì‹œê°„ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ í™•ì¸
- ìë™ ê²°ì œ ë° ì˜ˆì•½ í™•ì •
- ì§„ë£Œ ì „ë‚ /ë‹¹ì¼ ìë™ ì•Œë¦¼

---

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```typescript
// ë³‘ì› ì˜ˆì•½ ì‹œìŠ¤í…œ í†µí•©
interface HospitalBookingSystem {
  // ì—°ë™ ë°©ì‹ 1: ë³‘ì› ìì²´ API (ëŒ€í˜• ë³‘ì›)
  hospitalAPI?: {
    endpoint: string;
    authKey: string;
    type: 'rest' | 'soap';
  };

  // ì—°ë™ ë°©ì‹ 2: ì¤‘ê°œ í”Œë«í¼ (ë‹¥í„°ë‚˜ìš°, êµ¿ë‹¥ ë“±)
  platformAPI?: {
    platform: 'doctornow' | 'goodoc' | 'ddocdoc';
    apiKey: string;
  };

  // ì—°ë™ ë°©ì‹ 3: ìì²´ ìˆ˜ê¸° ê´€ë¦¬ (ì†Œí˜• ë³‘ì›)
  manualBooking?: {
    hospitalId: string;
    adminPhone: string;
    confirmationMethod: 'call' | 'sms';
  };
}
```

---

## ë³‘ì› ì˜ˆì•½ í”Œë¡œìš°

### 1. ë³‘ì› ê²€ìƒ‰ ë° ì„ íƒ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë³‘ì› ì°¾ê¸°                           â”‚
â”‚                                      â”‚
â”‚  ì •í˜•ì™¸ê³¼ ê²€ìƒ‰ ê²°ê³¼ (15ê³³)          â”‚
â”‚                                      â”‚
â”‚  1. ì„œìš¸ëŒ€í•™êµë³‘ì›                  â”‚
â”‚     â­â­â­â­â­ 4.8                 â”‚
â”‚     ğŸ“ ì„œìš¸ì‹œ ì¢…ë¡œêµ¬ (2.3km)       â”‚
â”‚                                      â”‚
â”‚     ğŸ’¡ ì‹¤ì‹œê°„ ì˜ˆì•½ ê°€ëŠ¥ âœ…          â”‚
â”‚     ì˜¤ëŠ˜ ì˜¤í›„ 3ì‹œ, 4ì‹œ ì˜ˆì•½ ê°€ëŠ¥    â”‚
â”‚                                      â”‚
â”‚     [ì˜ˆì•½í•˜ê¸°] [ìƒì„¸ë³´ê¸°]           â”‚
â”‚                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                      â”‚
â”‚  2. ê°•ë™ì„±ì‹¬ë³‘ì›                    â”‚
â”‚     â­â­â­â­ 4.5                   â”‚
â”‚     ğŸ“ ì „í™” ì˜ˆì•½ë§Œ ê°€ëŠ¥             â”‚
â”‚                                      â”‚
â”‚     [ì „í™”í•˜ê¸°] [ìƒì„¸ë³´ê¸°]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ì§„ë£Œê³¼/ì˜ì‚¬ ì„ íƒ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì„œìš¸ëŒ€í•™êµë³‘ì›                     â”‚
â”‚  ì§„ë£Œê³¼ ì„ íƒ                         â”‚
â”‚                                      â”‚
â”‚  ì •í˜•ì™¸ê³¼                            â”‚
â”‚                                      â”‚
â”‚  ë‹´ë‹¹ ì˜ì‚¬ ì„ íƒ *                    â”‚
â”‚                                      â”‚
â”‚  â—‰ ë°•OO êµìˆ˜ (ë¬´ë¦ ê´€ì ˆ ì „ë¬¸)      â”‚
â”‚     â­ 4.9 (234ê°œ ë¦¬ë·°)            â”‚
â”‚     ì˜¤ëŠ˜ ì˜ˆì•½ ê°€ëŠ¥: ì˜¤í›„ 3ì‹œ, 4ì‹œ   â”‚
â”‚                                      â”‚
â”‚  â—‹ ê¹€OO êµìˆ˜ (ì²™ì¶” ì „ë¬¸)           â”‚
â”‚     â­ 4.8 (189ê°œ ë¦¬ë·°)            â”‚
â”‚     ë‚´ì¼ë¶€í„° ì˜ˆì•½ ê°€ëŠ¥              â”‚
â”‚                                      â”‚
â”‚  â—‹ ì•„ë¬´ë‚˜ (ë¹ ë¥¸ ì˜ˆì•½)              â”‚
â”‚     ê°€ì¥ ë¹ ë¥¸ ì‹œê°„ìœ¼ë¡œ ë°°ì •         â”‚
â”‚                                      â”‚
â”‚  [ë‹¤ìŒ]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ë‚ ì§œ ë° ì‹œê°„ ì„ íƒ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì˜ˆì•½ ë‚ ì§œ ì„ íƒ                      â”‚
â”‚                                      â”‚
â”‚  2025ë…„ 2ì›”                          â”‚
â”‚                                      â”‚
â”‚  ì›”  í™”  ìˆ˜  ëª©  ê¸ˆ  í†   ì¼         â”‚
â”‚  17  18  19  20  21  22  23         â”‚
â”‚  â—   â—   â—   â—‰   â—   âœ•   âœ•        â”‚
â”‚                                      â”‚
â”‚  â— ì˜ˆì•½ ê°€ëŠ¥  â—‰ ì„ íƒë¨  âœ• ë¶ˆê°€ëŠ¥   â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  2025-02-20 (ëª©) ê°€ëŠ¥í•œ ì‹œê°„        â”‚
â”‚                                      â”‚
â”‚  ì˜¤ì „                                â”‚
â”‚  [09:00] [10:00] [11:00 âœ•]         â”‚
â”‚                                      â”‚
â”‚  ì˜¤í›„                                â”‚
â”‚  [14:00] [â—‰ 15:00] [16:00]         â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  ì„ íƒí•œ ì˜ˆì•½:                        â”‚
â”‚  2025-02-20 (ëª©) ì˜¤í›„ 3ì‹œ           â”‚
â”‚  ë°•OO êµìˆ˜ (ì •í˜•ì™¸ê³¼)               â”‚
â”‚                                      â”‚
â”‚  [ë‹¤ìŒ]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. í™˜ì ì •ë³´ ì…ë ¥
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  í™˜ì ì •ë³´ í™•ì¸                      â”‚
â”‚                                      â”‚
â”‚  ì´ë¦„ *                              â”‚
â”‚  [í™ê¸¸ìˆœ]                           â”‚
â”‚                                      â”‚
â”‚  ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ (ì•ìë¦¬) *             â”‚
â”‚  [500315]                           â”‚
â”‚                                      â”‚
â”‚  ì „í™”ë²ˆí˜¸ *                          â”‚
â”‚  [010-1234-5678]                    â”‚
â”‚                                      â”‚
â”‚  ì¦ìƒ ë° ë‚´ì› ì‚¬ìœ  *                 â”‚
â”‚  [ë¬´ë¦ì´ ë¶“ê³  ì•„íŒŒìš”.               â”‚
â”‚   ê³„ë‹¨ ì˜¤ë¥´ë‚´ë¦¬ê¸°ê°€ í˜ë“­ë‹ˆë‹¤]       â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  â˜‘ ì´ˆì§„ì…ë‹ˆë‹¤                       â”‚
â”‚  â˜ ì¬ì§„ì…ë‹ˆë‹¤                       â”‚
â”‚                                      â”‚
â”‚  [ë‹¤ìŒ]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. ê²°ì œ ë° ì˜ˆì•½ í™•ì •
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì˜ˆì•½ ì •ë³´ í™•ì¸ ë° ê²°ì œ              â”‚
â”‚                                      â”‚
â”‚  â”â”â” ì˜ˆì•½ ì •ë³´ â”â”â”                 â”‚
â”‚                                      â”‚
â”‚  ë³‘ì›: ì„œìš¸ëŒ€í•™êµë³‘ì›               â”‚
â”‚  ì§„ë£Œê³¼: ì •í˜•ì™¸ê³¼                   â”‚
â”‚  ë‹´ë‹¹ì˜: ë°•OO êµìˆ˜                  â”‚
â”‚  ë‚ ì§œ: 2025-02-20 (ëª©)              â”‚
â”‚  ì‹œê°„: ì˜¤í›„ 3ì‹œ (15:00)             â”‚
â”‚  í™˜ì: í™ê¸¸ìˆœ                       â”‚
â”‚                                      â”‚
â”‚  â”â”â” ì˜ˆì•½ê¸ˆ ê²°ì œ â”â”â”               â”‚
â”‚                                      â”‚
â”‚  ì˜ˆì•½ê¸ˆ: 10,000ì›                   â”‚
â”‚  (ì§„ë£Œë¹„ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤)            â”‚
â”‚                                      â”‚
â”‚  ğŸ’³ ê²°ì œ ìˆ˜ë‹¨                       â”‚
â”‚  â—‰ ì¹´ë“œ ê²°ì œ                        â”‚
â”‚  â—‹ ê³„ì¢Œì´ì²´                         â”‚
â”‚  â—‹ ë„¤ì´ë²„í˜ì´                       â”‚
â”‚  â—‹ ì¹´ì¹´ì˜¤í˜ì´                       â”‚
â”‚                                      â”‚
â”‚  ì¹´ë“œ ì„ íƒ:                          â”‚
â”‚  [KBêµ­ë¯¼ì¹´ë“œ ****1234 â–¼]           â”‚
â”‚                                      â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”‚
â”‚                                      â”‚
â”‚  â˜‘ ì˜ˆì•½ ì·¨ì†Œ ê·œì •ì— ë™ì˜í•©ë‹ˆë‹¤      â”‚
â”‚  â€¢ ì§„ë£Œ 1ì¼ ì „ê¹Œì§€: ì „ì•¡ í™˜ë¶ˆ       â”‚
â”‚  â€¢ ì§„ë£Œ ë‹¹ì¼: í™˜ë¶ˆ ë¶ˆê°€             â”‚
â”‚                                      â”‚
â”‚  [10,000ì› ê²°ì œí•˜ê³  ì˜ˆì•½í•˜ê¸°]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6. ì˜ˆì•½ ì™„ë£Œ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!          â”‚
â”‚                                      â”‚
â”‚  ì˜ˆì•½ë²ˆí˜¸: A2025022001              â”‚
â”‚                                      â”‚
â”‚  â”â”â” ì˜ˆì•½ ì •ë³´ â”â”â”                 â”‚
â”‚                                      â”‚
â”‚  ğŸ“… 2025-02-20 (ëª©) ì˜¤í›„ 3ì‹œ        â”‚
â”‚  ğŸ¥ ì„œìš¸ëŒ€í•™êµë³‘ì› ì •í˜•ì™¸ê³¼         â”‚
â”‚  ğŸ‘¨â€âš•ï¸ ë°•OO êµìˆ˜                    â”‚
â”‚                                      â”‚
â”‚  ğŸ“ ì˜¤ì‹œëŠ” ê¸¸                       â”‚
â”‚  ì„œìš¸ì‹œ ì¢…ë¡œêµ¬ ëŒ€í•™ë¡œ 101           â”‚
â”‚  [ì§€ë„ ë³´ê¸°]                        â”‚
â”‚                                      â”‚
â”‚  â”â”â” ì¤€ë¹„ ì‚¬í•­ â”â”â”                 â”‚
â”‚                                      â”‚
â”‚  âœ“ ì‹ ë¶„ì¦ ì§€ì°¸                      â”‚
â”‚  âœ“ ê±´ê°•ë³´í—˜ì¦ ì§€ì°¸                  â”‚
â”‚  âœ“ ì§„ë£Œ 30ë¶„ ì „ ë„ì°© ê¶Œì¥           â”‚
â”‚                                      â”‚
â”‚  â”â”â” ì•Œë¦¼ ì„¤ì • â”â”â”                 â”‚
â”‚                                      â”‚
â”‚  â˜‘ 1ì¼ ì „ ì•Œë¦¼ (2/19 ì˜¤í›„ 3ì‹œ)     â”‚
â”‚  â˜‘ 2ì‹œê°„ ì „ ì•Œë¦¼ (2/20 ì˜¤í›„ 1ì‹œ)   â”‚
â”‚  â˜‘ ê°€ì¡±ì—ê²Œ ì•Œë¦¼                    â”‚
â”‚                                      â”‚
â”‚  [ìº˜ë¦°ë”ì— ì¶”ê°€] [ê³µìœ í•˜ê¸°]         â”‚
â”‚  [ì˜ˆì•½ ìƒì„¸ ë³´ê¸°]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## DB ìŠ¤í‚¤ë§ˆ

```sql
-- ë³‘ì› ì •ë³´ (Phase 1ì—ì„œ í™•ì¥)
CREATE TABLE hospitals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(200) NOT NULL,
  address TEXT NOT NULL,
  latitude DECIMAL(10, 8),
  longitude DECIMAL(11, 8),
  phone VARCHAR(20),

  -- ì‹¤ì‹œê°„ ì˜ˆì•½ ì§€ì› ì—¬ë¶€
  online_booking_enabled BOOLEAN DEFAULT false,
  booking_system_type VARCHAR(50), -- 'api', 'platform', 'manual'
  api_endpoint TEXT,
  api_key_encrypted TEXT,

  departments TEXT[], -- ['ë‚´ê³¼', 'ì •í˜•ì™¸ê³¼', ...]
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì˜ì‚¬ ì •ë³´
CREATE TABLE doctors (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  hospital_id UUID NOT NULL REFERENCES hospitals(id),
  name VARCHAR(100) NOT NULL,
  department VARCHAR(100) NOT NULL,
  specialization TEXT,
  photo_url TEXT,
  rating DECIMAL(2, 1) DEFAULT 0,
  review_count INTEGER DEFAULT 0,
  active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ ìŠ¬ë¡¯
CREATE TABLE available_time_slots (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  doctor_id UUID NOT NULL REFERENCES doctors(id),
  date DATE NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  is_available BOOLEAN DEFAULT true,
  max_patients INTEGER DEFAULT 1,
  current_patients INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(doctor_id, date, start_time)
);

-- ë³‘ì› ì˜ˆì•½
CREATE TABLE hospital_bookings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  booking_number VARCHAR(50) UNIQUE NOT NULL,
  user_id UUID NOT NULL REFERENCES users(id),

  -- ë³‘ì› ë° ì˜ì‚¬ ì •ë³´
  hospital_id UUID NOT NULL REFERENCES hospitals(id),
  doctor_id UUID REFERENCES doctors(id),
  department VARCHAR(100) NOT NULL,

  -- ì˜ˆì•½ ì¼ì‹œ
  appointment_date DATE NOT NULL,
  appointment_time TIME NOT NULL,
  time_slot_id UUID REFERENCES available_time_slots(id),

  -- í™˜ì ì •ë³´
  patient_name VARCHAR(100) NOT NULL,
  patient_ssn_prefix VARCHAR(6), -- ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬
  patient_phone VARCHAR(20) NOT NULL,
  symptoms TEXT,

  -- ì˜ˆì•½ íƒ€ì…
  is_first_visit BOOLEAN DEFAULT true,

  -- ê²°ì œ ì •ë³´
  deposit_amount INTEGER DEFAULT 0,
  payment_method VARCHAR(50),
  payment_id VARCHAR(100),
  paid_at TIMESTAMP WITH TIME ZONE,

  -- ìƒíƒœ
  status VARCHAR(20) DEFAULT 'confirmed',
  -- 'confirmed', 'completed', 'cancelled', 'no_show'

  -- ì·¨ì†Œ ì •ë³´
  cancelled_at TIMESTAMP WITH TIME ZONE,
  cancellation_reason TEXT,
  refund_amount INTEGER,
  refunded_at TIMESTAMP WITH TIME ZONE,

  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì˜ˆì•½ ì•Œë¦¼ ê¸°ë¡
CREATE TABLE booking_notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  booking_id UUID NOT NULL REFERENCES hospital_bookings(id),
  notification_type VARCHAR(50) NOT NULL,
  -- '1_day_before', '2_hours_before', 'confirmed', 'cancelled'
  sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  recipient_id UUID NOT NULL REFERENCES users(id)
);
```

---

## API ì—”ë“œí¬ì¸íŠ¸

### ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ ì¡°íšŒ
```typescript
// GET /api/hospitals/:hospitalId/doctors/:doctorId/available-slots?date=2025-02-20
export async function GET(
  req: Request,
  { params }: { params: { hospitalId: string; doctorId: string } }
) {
  const { searchParams } = new URL(req.url);
  const date = searchParams.get('date');

  // ì‹¤ì‹œê°„ ì˜ˆì•½ ì‹œìŠ¤í…œ ì—°ë™
  const hospital = await supabase
    .from('hospitals')
    .select('*')
    .eq('id', params.hospitalId)
    .single();

  let availableSlots;

  if (hospital.data.booking_system_type === 'api') {
    // ë³‘ì› API ì§ì ‘ í˜¸ì¶œ
    availableSlots = await fetchHospitalAPI(
      hospital.data.api_endpoint,
      params.doctorId,
      date
    );
  } else if (hospital.data.booking_system_type === 'platform') {
    // ì¤‘ê°œ í”Œë«í¼ API í˜¸ì¶œ
    availableSlots = await fetchPlatformAPI(
      hospital.data.platform,
      params.hospitalId,
      params.doctorId,
      date
    );
  } else {
    // ìì²´ DB ì¡°íšŒ
    const { data } = await supabase
      .from('available_time_slots')
      .select('*')
      .eq('doctor_id', params.doctorId)
      .eq('date', date)
      .eq('is_available', true)
      .order('start_time');

    availableSlots = data;
  }

  return Response.json({ success: true, data: availableSlots });
}
```

### ì˜ˆì•½ ìƒì„±
```typescript
// POST /api/hospital-bookings
export async function POST(req: Request) {
  const {
    userId,
    hospitalId,
    doctorId,
    appointmentDate,
    appointmentTime,
    timeSlotId,
    patientInfo,
    paymentMethod
  } = await req.json();

  // 1. ì˜ˆì•½ ë²ˆí˜¸ ìƒì„±
  const bookingNumber = generateBookingNumber();

  // 2. ì˜ˆì•½ê¸ˆ ê²°ì œ ì²˜ë¦¬
  const payment = await processPayment({
    amount: 10000,
    method: paymentMethod,
    userId,
    description: `ë³‘ì› ì˜ˆì•½ê¸ˆ - ${bookingNumber}`
  });

  if (!payment.success) {
    return Response.json({
      success: false,
      error: { code: 'PAYMENT_FAILED', message: 'ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤' }
    }, { status: 400 });
  }

  // 3. ì˜ˆì•½ ìƒì„±
  const { data: booking } = await supabase
    .from('hospital_bookings')
    .insert({
      booking_number: bookingNumber,
      user_id: userId,
      hospital_id: hospitalId,
      doctor_id: doctorId,
      appointment_date: appointmentDate,
      appointment_time: appointmentTime,
      time_slot_id: timeSlotId,
      patient_name: patientInfo.name,
      patient_ssn_prefix: patientInfo.ssnPrefix,
      patient_phone: patientInfo.phone,
      symptoms: patientInfo.symptoms,
      is_first_visit: patientInfo.isFirstVisit,
      deposit_amount: 10000,
      payment_method: paymentMethod,
      payment_id: payment.id,
      paid_at: new Date(),
      status: 'confirmed'
    })
    .select()
    .single();

  // 4. ì‹œê°„ ìŠ¬ë¡¯ ì—…ë°ì´íŠ¸
  if (timeSlotId) {
    await supabase
      .from('available_time_slots')
      .update({
        is_available: false,
        current_patients: supabase.raw('current_patients + 1')
      })
      .eq('id', timeSlotId);
  }

  // 5. ë³‘ì›ì— ì˜ˆì•½ ì •ë³´ ì „ì†¡ (API ì—°ë™)
  await sendBookingToHospital(hospitalId, booking);

  // 6. ì‚¬ìš©ìì—ê²Œ í™•ì¸ ì•Œë¦¼
  await sendNotification({
    userId,
    title: 'âœ… ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
    body: `${appointmentDate} ${appointmentTime} ë³‘ì› ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤`,
    data: {
      type: 'booking_confirmed',
      bookingId: booking.id
    }
  });

  // 7. ê°€ì¡±ì—ê²Œ ì•Œë¦¼
  await sendFamilyNotifications(userId, {
    title: 'ë³‘ì› ì˜ˆì•½ ì•Œë¦¼',
    body: `ì–´ë¨¸ë‹ˆê°€ ${appointmentDate}ì— ë³‘ì› ì˜ˆì•½ì„ í•˜ì…¨ìŠµë‹ˆë‹¤`,
    bookingId: booking.id
  });

  // 8. ì•Œë¦¼ ìŠ¤ì¼€ì¤„ ì„¤ì •
  await scheduleBookingReminders(booking);

  return Response.json({ success: true, data: booking });
}
```

### ì˜ˆì•½ ì·¨ì†Œ
```typescript
// POST /api/hospital-bookings/:id/cancel
export async function POST(
  req: Request,
  { params }: { params: { id: string } }
) {
  const { reason } = await req.json();

  const { data: booking } = await supabase
    .from('hospital_bookings')
    .select('*')
    .eq('id', params.id)
    .single();

  // í™˜ë¶ˆ ì •ì±… í™•ì¸
  const appointmentDateTime = new Date(
    `${booking.appointment_date} ${booking.appointment_time}`
  );
  const now = new Date();
  const hoursUntilAppointment =
    (appointmentDateTime.getTime() - now.getTime()) / (1000 * 60 * 60);

  let refundAmount = 0;
  if (hoursUntilAppointment >= 24) {
    // 1ì¼ ì „: ì „ì•¡ í™˜ë¶ˆ
    refundAmount = booking.deposit_amount;
  }

  // í™˜ë¶ˆ ì²˜ë¦¬
  if (refundAmount > 0) {
    await processRefund({
      paymentId: booking.payment_id,
      amount: refundAmount
    });
  }

  // ì˜ˆì•½ ì·¨ì†Œ ì²˜ë¦¬
  await supabase
    .from('hospital_bookings')
    .update({
      status: 'cancelled',
      cancelled_at: new Date(),
      cancellation_reason: reason,
      refund_amount: refundAmount,
      refunded_at: refundAmount > 0 ? new Date() : null
    })
    .eq('id', params.id);

  // ì‹œê°„ ìŠ¬ë¡¯ ë³µêµ¬
  if (booking.time_slot_id) {
    await supabase
      .from('available_time_slots')
      .update({
        is_available: true,
        current_patients: supabase.raw('current_patients - 1')
      })
      .eq('id', booking.time_slot_id);
  }

  // ë³‘ì›ì— ì·¨ì†Œ í†µë³´
  await notifyHospitalCancellation(booking);

  // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
  await sendNotification({
    userId: booking.user_id,
    title: 'ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤',
    body: refundAmount > 0
      ? `${refundAmount.toLocaleString()}ì›ì´ í™˜ë¶ˆë©ë‹ˆë‹¤`
      : 'ì·¨ì†Œ ìˆ˜ìˆ˜ë£Œê°€ ë¶€ê³¼ë˜ì—ˆìŠµë‹ˆë‹¤'
  });

  return Response.json({ success: true, refundAmount });
}
```

---

## ê²°ì œ ì‹œìŠ¤í…œ ì—°ë™

### PGì‚¬ ì—°ë™
```typescript
// í† ìŠ¤í˜ì´ë¨¼ì¸  ë˜ëŠ” NicePay ì‚¬ìš©
import { TossPayments } from '@tosspayments/sdk';

const tossPayments = new TossPayments(
  process.env.TOSS_CLIENT_KEY
);

export const processPayment = async ({
  amount,
  method,
  userId,
  description
}: PaymentRequest) => {
  try {
    const payment = await tossPayments.requestPayment(method, {
      amount,
      orderId: generateOrderId(),
      orderName: description,
      successUrl: `${process.env.NEXT_PUBLIC_URL}/payment/success`,
      failUrl: `${process.env.NEXT_PUBLIC_URL}/payment/fail`,
      customerName: await getUserName(userId)
    });

    return { success: true, id: payment.paymentKey };
  } catch (error) {
    return { success: false, error };
  }
};

export const processRefund = async ({
  paymentId,
  amount,
  reason
}: RefundRequest) => {
  const response = await fetch(
    `https://api.tosspayments.com/v1/payments/${paymentId}/cancel`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${Buffer.from(
          process.env.TOSS_SECRET_KEY + ':'
        ).toString('base64')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        cancelAmount: amount,
        cancelReason: reason || 'ì‚¬ìš©ì ìš”ì²­'
      })
    }
  );

  return await response.json();
};
```

---

## ìë™ ì•Œë¦¼ ì‹œìŠ¤í…œ

```typescript
// Cron Job: ë§¤ ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
export const sendBookingReminders = async () => {
  const now = new Date();

  // 1ì¼ ì „ ì•Œë¦¼
  const oneDayLater = new Date(now.getTime() + 24 * 60 * 60 * 1000);
  await sendRemindersForTime(oneDayLater, '1_day_before');

  // 2ì‹œê°„ ì „ ì•Œë¦¼
  const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);
  await sendRemindersForTime(twoHoursLater, '2_hours_before');
};

const sendRemindersForTime = async (
  targetTime: Date,
  notificationType: string
) => {
  const targetDate = format(targetTime, 'yyyy-MM-dd');
  const targetHour = targetTime.getHours();

  const { data: bookings } = await supabase
    .from('hospital_bookings')
    .select('*, user:users(*), hospital:hospitals(*)')
    .eq('appointment_date', targetDate)
    .eq('status', 'confirmed')
    .gte('appointment_time', `${targetHour}:00`)
    .lt('appointment_time', `${targetHour + 1}:00`);

  for (const booking of bookings) {
    // ì´ë¯¸ ì•Œë¦¼ì„ ë³´ë‚¸ ì  ìˆëŠ”ì§€ í™•ì¸
    const { data: sent } = await supabase
      .from('booking_notifications')
      .select('*')
      .eq('booking_id', booking.id)
      .eq('notification_type', notificationType)
      .single();

    if (sent) continue;

    // ì•Œë¦¼ ë°œì†¡
    await sendNotification({
      userId: booking.user_id,
      title: notificationType === '1_day_before'
        ? 'ğŸ“… ë‚´ì¼ ë³‘ì› ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤'
        : 'â° 2ì‹œê°„ í›„ ë³‘ì› ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤',
      body: `${booking.hospital.name} ${booking.department}\n${booking.appointment_time}`,
      data: {
        type: 'booking_reminder',
        bookingId: booking.id
      }
    });

    // ì•Œë¦¼ ê¸°ë¡
    await supabase.from('booking_notifications').insert({
      booking_id: booking.id,
      notification_type: notificationType,
      recipient_id: booking.user_id
    });
  }
};
```

---

## Phase 3 í™•ì¥ ê³„íš

### AI ê¸°ë°˜ ë³‘ì› ì¶”ì²œ
- ì¦ìƒ ì…ë ¥ ì‹œ ì í•©í•œ ë³‘ì›/ì˜ì‚¬ ìë™ ì¶”ì²œ
- ê³¼ê±° ì§„ë£Œ ê¸°ë¡ ê¸°ë°˜ ë§ì¶¤ ì¶”ì²œ

### ì›ê²© ì§„ë£Œ ì—°ë™
- í™”ìƒ ì§„ë£Œ ì‹œìŠ¤í…œ í†µí•©
- ì²˜ë°©ì „ ì „ì ë°œê¸‰

---

**ì‘ì„±ì¼**: 2025-01-24
**ë²„ì „**: 1.0
**ë‹¤ìŒ ë¬¸ì„œ**: 02-ë°”ì•¼ë‹¤-í™ˆí—¬ìŠ¤ì¼€ì–´-ì—°ë™.md
